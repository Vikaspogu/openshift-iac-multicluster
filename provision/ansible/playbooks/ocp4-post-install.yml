---
- hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - name: Load encrypted credentials
      community.sops.load_vars:
        file: ../roles/ocp4/vars/secret.sops.yml
        expressions: ignore

    - name: Get root level directory
      shell: "git rev-parse --show-toplevel"
      register: root_dir

    - name: Get kubeadmin password
      shell: "cat {{ root_dir.stdout_lines[0] }}/provision/kubeadmin-password"
      register: result_kubeadmin

    - name: oc login to cluster
      shell: "oc login https://api.{{clusterID}}.{{domain}}:6443 --username=kubeadmin --password={{result_kubeadmin.stdout_lines[0]}} --insecure-skip-tls-verify"

    - name: Provision base cluster operations
      shell: "oc apply -k {{root_dir.stdout_lines[0]}}/cluster/base/operators"
