---
- hosts: localhost
  connection: local
  gather_facts: false
  become: false
  tasks:
    - name: Load encrypted credentials
      community.sops.load_vars:
        file: ../roles/openshift-services/vars/secret.sops.yml
        expressions: ignore

    - name: Get root level directory
      shell: "git rev-parse --show-toplevel"
      register: root_dir

    - name: Get kubeadmin password
      shell: "cat {{ root_dir.stdout_lines[0] }}/provision/kubeadmin-password"
      register: result_kubeadmin

    - name: oc login to cluster
      shell: "oc login https://api.{{clusterID}}.{{domain}}:6443 --username=kubeadmin --password={{result_kubeadmin.stdout_lines[0]}} --insecure-skip-tls-verify"

    - name: Provision bootstrapping operators
      shell: "oc apply -k {{root_dir.stdout_lines[0]}}/cluster/bootstrapping/operators"

    - name: Wait for openshift-gitops-server pods to rollout
      shell: "oc rollout status -n openshift-gitops deployment/openshift-gitops-server"
      register: rollout_status
      until: rollout_status.rc == 0
      retries: 30
      delay: 60

    - name: Check if secret exists
      shell: oc get secret sops-age -n openshift-gitops
      register: result
      ignore_errors: true

    - name: Create sops key secret for decryption
      shell: "cat ~/.config/sops/age/keys.txt | oc create secret generic sops-age -n openshift-gitops --from-file=keys.txt=/dev/stdin"
      when: '"not found" in result.stderr'

    - name: Apply argo label to Openshift config namespace
      shell: "oc label namespace openshift-config argocd.argoproj.io/managed-by=openshift-gitops --overwrite"

    - name: Update openshift-gitops instance
      shell: "oc apply -k {{root_dir.stdout_lines[0]}}/cluster/bootstrapping/openshift-gitops"

    - name: Wait for openshift-gitops-server pods to rollout
      shell: "oc rollout status -n openshift-gitops deployment/openshift-gitops-server"
      register: rollout_status
      until: rollout_status.rc == 0
      retries: 30
      delay: 60

    - name: Create ArgoCD applications
      shell: "oc apply -k {{root_dir.stdout_lines[0]}}/cluster/bootstrapping/argo-applications"
