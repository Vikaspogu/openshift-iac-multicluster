- name: Configure httpd to listen on 8080
  template:
    src: ./templates/httpd.conf
    dest: /etc/httpd/conf/httpd.conf
    force: yes
    mode: "u=rw,g=r,o=r"

- name: Create TFTP directories for auto boot and rhcos
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
    - "/var/lib/tftpboot/pxelinux.cfg"
    - "/var/lib/tftpboot/rhcos"

- name: setup TFTP
  shell: "cp -a /usr/share/syslinux/* /var/lib/tftpboot"

- name: restart tftp service
  service:
    name: tftp
    enabled: yes
    state: restarted

- name: configure haproxy
  template:
    src: ./templates/haproxy.j2
    dest: /etc/haproxy/haproxy.cfg
    force: yes
    mode: "u=rw,g=r,o=r"

- name: make sure the haproxy can bind to 6443
  shell:
    cmd: setsebool -P haproxy_connect_any=1

- name: restart the haproxy
  service:
    name: haproxy
    enabled: yes
    state: restarted
