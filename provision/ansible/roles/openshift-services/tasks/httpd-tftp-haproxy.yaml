- name: Configure httpd to listen on 8080
  ansible.builtin.template:
    src: "./templates/{{item.template_src}}"
    dest: "{{ item.template_dest }}"
    force: yes
    mode: "u=rw,g=r,o=r"
  loop:
    - { template_src: 'httpd.conf', template_dest: '/etc/httpd/conf/httpd.conf' }
    - { template_src: 'haproxy.j2', template_dest: '/etc/haproxy/haproxy.cfg' }

- name: Create TFTP directories for auto boot and rhcos
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  loop:
    - "/var/lib/tftpboot/pxelinux.cfg"
    - "/var/lib/tftpboot/rhcos"

- name: Run shell commands to copy tftpboot files and setsebool for haproxy
  ansible.builtin.shell:
    cmd: "{{item}}"
  loop:
    - "cp -a /usr/share/syslinux/* /var/lib/tftpboot"
    - "setsebool -P haproxy_connect_any=1"

- name: restart tftp service
  ansible.builtin.service:
    name: "{{item}}"
    enabled: yes
    state: restarted
  loop:
    - tftp
    - haproxy
