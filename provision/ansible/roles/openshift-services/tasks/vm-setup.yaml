---
- name: "Replace line in file DNS"
  become: true
  ansible.builtin.replace:
    path: /etc/systemd/resolved.conf
    regexp: '^#DNS=$'
    replace: "DNS={{dns}}"
  register: inline_dns_change

- name: Restart systemd-resolved
  become: true
  ansible.builtin.service:
    name: "systemd-resolved"
    state: reloaded
  when: inline_dns_change is changed

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone }}"
  when:
    - timezone is defined

- name: Add user to sudoers
  become: true
  ansible.builtin.copy:
    content: "{{ ansible_user }} ALL=(ALL:ALL) NOPASSWD:ALL"
    dest: "/etc/sudoers.d/{{ ansible_user }}_nopasswd"
    mode: "0440"

- name: Disable IPv6
  become: true
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: "1"
    sysctl_set: true
    state: present
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6

- name: Add additional user SSH public keys
  become: true
  ansible.posix.authorized_key:
    user: "{{ ansible_user }}"
    key: "{{ item }}"
  loop: "{{ ssh_authorized_keys }}"
  when:
    - ssh_authorized_keys is defined
    - ssh_authorized_keys is iterable
    - ssh_authorized_keys | length > 0

- name: generate SSH key
  become: true
  community.crypto.openssh_keypair:
    path: "~/.ssh/id_rsa"
    type: rsa
    size: 4096
    state: present
    force: no

- name: Install packages
  become: true
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ infra.packages }}"
  register: apt_install_common
  retries: 1
  delay: 60
  until: apt_install_common is success

- name: Start firewalld
  become: true
  ansible.builtin.service:
    name: "{{item}}"
    state: restarted
    enabled: true
  loop:
    - firewalld

- name: Open up firewall ports
  become: true
  ansible.posix.firewalld:
    permanent: yes
    immediate: yes
    state: enabled
    port: "{{ item }}"
  loop: "{{ infra.ports }}"
  run_once: true

- name: Open up firewall services
  become: true
  ansible.posix.firewalld:
    permanent: yes
    immediate: yes
    state: enabled
    service: "{{ item }}"
  loop:
    - tftp
  run_once: true
