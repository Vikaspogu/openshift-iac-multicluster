---
- name: download cloud image
  ansible.builtin.get_url:
    url: "{{ proxmox.fedora_vm_template.cloud_image_url }}"
    dest: "{{ proxmox.fedora_vm_template.cloud_image_path }}"
    mode: 0700

- name: create a VM to use as a template
  ansible.builtin.command: "qm create {{ proxmox.fedora_vm_template.id }} --name {{ proxmox.fedora_vm_template.name }} --memory {{ proxmox.fedora_vm_template.memory }} --net0 virtio,bridge=vmbr0"

- name: import disk image
  ansible.builtin.command: "qm importdisk {{ proxmox.fedora_vm_template.id }} {{ proxmox.fedora_vm_template.cloud_image_path }} {{ proxmox.fedora_vm_template.storage }}"

- name: configure VM to use imported image
  ansible.builtin.command: "qm set {{ proxmox.fedora_vm_template.id }} --scsihw virtio-scsi-pci --scsi0 {{ proxmox.fedora_vm_template.storage }}:vm-{{ proxmox.fedora_vm_template.id }}-disk-0"

- name: add cloud-init image as CDROM
  ansible.builtin.command: "qm set {{ proxmox.fedora_vm_template.id }} --ide2 {{ proxmox.fedora_vm_template.storage }}:cloudinit"

- name: configure boot from the image
  ansible.builtin.command: "qm set {{ proxmox.fedora_vm_template.id }} --boot c --bootdisk scsi0"

- name: attach serial console
  ansible.builtin.command: "qm set {{ proxmox.fedora_vm_template.id }} --serial0 socket --vga serial0"

- name: create template
  ansible.builtin.command: "qm template {{ proxmox.fedora_vm_template.id }}"
