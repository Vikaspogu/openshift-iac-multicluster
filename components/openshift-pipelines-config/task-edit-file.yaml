apiVersion: tekton.dev/v1beta1
kind: ClusterTask
metadata:
  annotations:
    tekton.dev/pipelines.minVersion: 0.12.1
  name: edit-file
  labels:
    app.kubernetes.io/version: 0.1.0
spec:
  description: >-
    This task will update the image tag in the values file for the app's corresponding environment.
  params:
    - name: repo_name
      type: string
    - name: helm_deploy_values
      type: string
    - name: image_tag
      type: string
    - name: sha_hash
      type: string

  results:
    - description: returns exit status of command
      name: exit_status
      type: string

  workspaces:
    - name: output
      description: workspace onto which the file is updated

  steps:
    - name: edit-file
      resources: {}
      image: alpine:edge
      workingDir: $(workspaces.output.path)
      script: |
        #!/bin/sh
        sed -ie 's|^  sha_hash:.*|  sha_hash: "$(params.sha_hash)"|' $(params.helm_deploy_values)
        sed -ie 's|^  tag:.*|  tag: "$(params.image_tag)"|' $(params.helm_deploy_values)
        cat $(params.helm_deploy_values)
        echo $?
