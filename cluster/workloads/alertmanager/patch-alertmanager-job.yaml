---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: patch-alertmanager-secret
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - get
      - list
      - patch
      - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: patch-alertmanager-secret
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: patch-alertmanager-secret
subjects:
  - kind: ServiceAccount
    name: patch-alertmanager-secret
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: patch-alertmanager-secret
---
apiVersion: batch/v1
kind: Job
metadata:
  name: &app patch-alertmanager-secret
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      containers:
        - image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
          env:
            - name: WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: alertmanager-webhook
                  key: WEBHOOK
          command:
            - "/bin/bash"
            - &scriptPath "/app/patch-alertmanager.sh"
          volumeMounts:
            - name: *app
              mountPath: *scriptPath
              subPath: &scriptName patch-alertmanager.sh
              readOnly: true
          name: *app
      volumes:
        - name: *app
          projected:
            defaultMode: 0775
            sources:
              - configMap:
                  name: patch-alertmanager
                  items:
                    - key: *scriptName
                      path: *scriptName
      dnsPolicy: ClusterFirst
      restartPolicy: Never
      terminationGracePeriodSeconds: 30
      serviceAccount: patch-alertmanager-secret
      serviceAccountName: patch-alertmanager-secret
