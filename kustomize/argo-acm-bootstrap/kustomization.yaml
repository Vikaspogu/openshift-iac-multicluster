---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../bases/openshift-gitops-config/

patches:
  - target:
      kind: ArgoCD
    patch: |-
      - op: replace
        path: /spec/repo
        value:
          env:
            - name: XDG_CONFIG_HOME
              value: /.config
            - name: SOPS_AGE_KEY_FILE
              value: /.config/sops/age/keys.txt
            - name: KUSTOMIZE_PLUGIN_HOME
              value: /etc/kustomize/plugin
          volumes:
            - name: custom-tools
              emptyDir: {}
            - emptyDir: {}
              name: policy-generator
            - name: sops-age
              secret:
                secretName: sops-age
          initContainers:
            - name: install-custom-tools
              image: viaductoss/ksops:v4.1.0
              command: ["/bin/sh", "-c"]
              args:
                - 'echo "Installing KSOPS..."; cp ksops /custom-tools/; cp $GOPATH/bin/kustomize /custom-tools/; echo "Done.";'
              volumeMounts:
                - mountPath: /custom-tools
                  name: custom-tools
            - name: download-helm-311
              image: alpine:3.8
              command: [sh, -c]
              args:
                - wget -O /tmp/helm-3.11 https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/helm/3.11.1/helm-linux-amd64 && mv /tmp/helm-3.11 /custom-tools/ && chmod +x /custom-tools/helm-3.11 ;
              volumeMounts:
                - mountPath: /custom-tools
                  name: custom-tools
            - args:
              - -c
              - cp /etc/kustomize/plugin/policy.open-cluster-management.io/v1/policygenerator/PolicyGenerator
                /policy-generator/PolicyGenerator
              command:
                - /bin/bash
              image: registry.redhat.io/rhacm2/multicluster-operators-subscription-rhel8:v2.7
              name: policy-generator-install
              volumeMounts:
                - mountPath: /policy-generator
                  name: policy-generator
          volumeMounts:
            - mountPath: /etc/kustomize/plugin/policy.open-cluster-management.io/v1/policygenerator
              name: policy-generator
            - mountPath: /usr/local/bin/kustomize
              name: custom-tools
              subPath: kustomize
            - mountPath: /usr/local/bin/helm-3.11
              name: custom-tools
              subPath: helm-3.11
            - mountPath: /.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
              name: custom-tools
              subPath: ksops
            - mountPath: /.config/sops/age/keys.txt
              name: sops-age
              subPath: keys.txt
          resources:
            limits:
              cpu: "1"
              memory: 1Gi
            requests:
              cpu: 250m
              memory: 256Mi
