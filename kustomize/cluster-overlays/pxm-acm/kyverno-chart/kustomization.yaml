---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: kyverno
resources:
  - ../../../bases/kyverno-chart/
commonAnnotations:
  argocd.argoproj.io/sync-options: ServerSideApply=true
helmCharts:
  - name: kyverno
    releaseName: kyverno
    namespace: kyverno
    repo: https://kyverno.github.io/kyverno/
    version: 3.0.1
    valuesInline:
      crds:
        install: true
      backgroundController:
        serviceMonitor:
          enabled: true
        rbac:
          clusterRole:
            extraResources:
              - apiGroups:
                  - ""
                resources:
                  - pods
              - apiGroups:
                  - batch
                resources:
                  - cronjobs
                  - jobs
      cleanupController:
        serviceMonitor:
          enabled: true
      reportsController:
        serviceMonitor:
          enabled: true
      admissionController:
        replicas: 3
        serviceMonitor:
          enabled: true
        rbac:
          clusterRole:
            extraResources:
              - apiGroups:
                  - ""
                resources:
                  - pods
                  - cronjobs
                verbs:
                  - create
                  - update
                  - delete
              - verbs:
                  - create
                  - delete
                  - deletecollection
                  - patch
                  - update
                apiGroups:
                  - batch
                resources:
                  - cronjobs
                  - jobs
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: kubernetes.io/hostname
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app.kubernetes.io/instance: kyverno
                app.kubernetes.io/component: kyverno
